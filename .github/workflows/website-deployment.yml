name: Website Deployment

on:
  push:
    branches:
      - main
    paths:
      - "website/**"
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to deploy to"
        required: true
        default: "dev"
        type: choice
        options:
          - dev
          - staging
          - prod

permissions:
  id-token: write
  contents: read

env:
  STACK_NAME: PortfolioInfraStack
  AWS_REGION: us-east-1

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./website

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: website/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Build website
        run: npm run build

      - name: Debug build output
        run: |
          echo "Contents of dist directory:"
          ls -la dist/
          echo "Current working directory:"
          pwd

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: website-build
          path: website/dist

  deploy:
    needs: build-and-test
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'dev' }}

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-actions-role
          aws-region: ${{ env.AWS_REGION }}

      - name: Debug OIDC claims
        run: |
          echo "GitHub SHA: ${{ github.sha }}"
          echo "GitHub ref: ${{ github.ref }}"
          echo "GitHub repository: ${{ github.repository }}"
          echo "Stage: ${{ github.event.inputs.environment || 'dev' }}"

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: website-build
          path: dist

      - name: Debug downloaded artifact
        run: |
          echo "Contents of dist directory after download:"
          ls -la dist/
          echo "Current working directory:"
          pwd

      - name: Deploy to S3
        run: |
          STAGE="${{ github.event.inputs.environment || 'dev' }}"
          BUCKET_NAME="portfolio-${STAGE}-${{ secrets.AWS_ACCOUNT_ID }}"

          echo "Deploying static assets to S3 bucket: ${BUCKET_NAME}"

          # Deploy static assets with long cache duration
          if ! aws s3 sync dist "s3://${BUCKET_NAME}" \
            --delete \
            --cache-control "max-age=31536000,public" \
            --exclude "*.html" \
            --exclude "*.json"; then
            echo "Failed to sync static assets to S3"
            exit 1
          fi

          echo "Deploying HTML and JSON files with no-cache directive"

          # Deploy HTML and JSON files with different cache settings
          if ! aws s3 sync dist "s3://${BUCKET_NAME}" \
            --delete \
            --cache-control "no-cache" \
            --include "*.html" \
            --include "*.json"; then
            echo "Failed to sync HTML/JSON files to S3"
            exit 1
          fi

      - name: Set S3 file permissions
        run: |
          STAGE="${{ github.event.inputs.environment || 'dev' }}"
          BUCKET_NAME="portfolio-${STAGE}-${{ secrets.AWS_ACCOUNT_ID }}"

          # Set proper content type for CSS
          aws s3 cp s3://${BUCKET_NAME}/output.css s3://${BUCKET_NAME}/output.css --content-type "text/css" --metadata-directive REPLACE

          # Only set JS file permissions if file exists
          if aws s3 ls "s3://${BUCKET_NAME}/js/main.js" &> /dev/null; then
            aws s3 cp s3://${BUCKET_NAME}/js/main.js s3://${BUCKET_NAME}/js/main.js --content-type "application/javascript" --metadata-directive REPLACE
            aws s3api get-object-acl --bucket ${BUCKET_NAME} --key js/main.js
          else
            echo "Warning: js/main.js not found in bucket"
          fi

      - name: Verify S3 deployment
        run: |
          STAGE="${{ github.event.inputs.environment || 'dev' }}"
          BUCKET_NAME="portfolio-${STAGE}-${{ secrets.AWS_ACCOUNT_ID }}"

          echo "Verifying deployment to bucket: ${BUCKET_NAME}"

          # Verify files were uploaded
          if ! aws s3 ls "s3://${BUCKET_NAME}" --recursive --summarize; then
            echo "Failed to verify S3 deployment"
            exit 1
          fi

      - name: Invalidate CloudFront
        run: |
          STAGE="${{ github.event.inputs.environment || 'dev' }}"
          echo "Looking for distribution ID for stage: $STAGE"

          # Updated query to match new output key format
          DISTRIBUTION_ID=$(aws cloudformation describe-stacks \
            --stack-name "PortfolioInfraStack-${STAGE}" \
            --query "Stacks[0].Outputs[?OutputKey=='DistributionId'].OutputValue" \
            --output text)

          echo "Found Distribution ID: $DISTRIBUTION_ID"

          if [ -z "$DISTRIBUTION_ID" ]; then
            echo "Error: Distribution ID not found for stage ${STAGE}"
            exit 1
          fi

          echo "Creating CloudFront invalidation for distribution: ${DISTRIBUTION_ID}"

          if ! aws cloudfront create-invalidation \
            --distribution-id "$DISTRIBUTION_ID" \
            --paths "/*"; then
            echo "Failed to create CloudFront invalidation"
            exit 1
          fi

      - name: Deployment Summary
        run: |
          STAGE="${{ github.event.inputs.environment || 'dev' }}"
          echo "Deployment completed successfully to ${STAGE} environment"
          echo "Timestamp: $(date)"
          echo "Commit: ${{ github.sha }}"
